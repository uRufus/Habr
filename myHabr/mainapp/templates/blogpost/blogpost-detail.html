{% extends 'authapp/base.html' %}
{% block title %}
    <title>
    {{ object.title }} - MyHabr
    </title>
{% endblock %}
{% block css %}
{{ block.super }}
    <style>
        a:hover {
           text-decoration: none;
        }

        .btn, .form-control {
          outline: none;
          -webkit-box-shadow: none !important;
          box-shadow: none !important;
          border-radius: 0;
        }

        .comment-body textarea {
            margin-bottom: 1em;
        }
        .children {
            padding-top: 1em !important;
            padding-bottom: 0 !important;
            margin-bottom: 1em !important;
        }
        .comment-list li {
            margin-bottom: 1em;
        }

    </style>
{%  endblock %}
{% block content %}
    <div class="container">
        <h1>{{ object.title }}</h1>
        <h2>Автор: {{ object.author }}</h2></br>
        <hr>
        </br>
        {{ object.body }}
        <hr>
        </br>
        </br>
        <a href="{% url 'blogpost'  %}"> НАЗАД </a> </br>
        <hr>
        </br>
        <h3 class="mb-5">Комментарии</h3>
        {% include 'comments/comments.html' %}
        <h3 class="mb-1">Оставить комментарий:</h3>
        <div class="comment-form-wrap pt-5">
            <form id="comment_form" class="p-5 bg-light">
                {% csrf_token %}
                <div class="form-group">
                    <label for="comment_text">Ваш комментарий:</label>
                    <textarea name="comment_text" class="form-control" id="comment_text" rows="4"></textarea>
                </div>
                <button id="comment_send" type="submit" class="btn btn-primary">Комментировать</button>
            </form>
        </div>
    </div>

    <script>
        let form = $('#comment_form');
        let send_comment = $('#comment_send');
        form.on('submit', function(event){
            event.preventDefault();
            create_post();
        });

        function create_post() {
        var comment_text = $('[name="comment_text"]').val();
        $.ajax({
            url : "/blog/comment/", // the endpoint
            type : "POST", // http method
            data : { comment_text : comment_text,
                     blog_id: {{ object.pk }},
                     csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success : function(json) {
                $('.comment-list').replaceWith(json.comments);
                $('[name="comment_text"]').val('');
            },
            error : function(xhr, errmsg, err) {
                console.log('error');
            }
        })
        }

        function sub_comment(e) {
            e.preventDefault();
            let subcomment = $(e.target).parent() ;
            let comment_id = subcomment.attr('id');
            let subcomment_text = subcomment.find('textarea').first();
            if (subcomment_text.is(":hidden")) {
                subcomment_text.attr("hidden", false);
            }
            else {
                let comment_text = subcomment_text.val()
                $.ajax({
                    url : "/blog/sub_comment/",
                    type : "POST",
                    data : { comment_text : comment_text,
                             comment_id: comment_id,
                             blog_id: {{ object.pk }},
                             csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success : function(json) {
                         {#$(e.target).parent().find('.children').remove();#}
                         {#$(e.target).parent().append(json.comment);#}
                         $(e.target).parent().next('.children').html(json.comment)
                         {#$(e.target).parent().find('.children').first().html(json.comment);#}
                    },
                    error : function(xhr, errmsg, err) {
                        console.log('error');
                    }
                }
               )
                subcomment_text.attr("hidden", true);
            }
        }

    </script>
{% endblock %}